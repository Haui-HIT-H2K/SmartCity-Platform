# Copyright 2025 Haui.HIT - H2K
# Licensed under the Apache License, Version 2.0
# http://www.apache.org/licenses/LICENSE-2.0

version: '3.8'

services:
  # =======================================================
  # VÙNG BIÊN (EDGE STORAGE LAYER) - RABBITMQ
  # Nơi hứng 40 triệu request đầu tiên
  # =======================================================
  
  # Subnet 1: Giả lập Edge Node khu vực A
  edge-subnet-1:
    image: rabbitmq:3-management-alpine
    container_name: rabbit-edge-1
    hostname: rabbit-edge-1
    restart: always
    ports:
      - "5672:5672"   # Port nhận data từ sensor (Python sim)
      - "15672:15672" # GUI quản lý
    environment:
      RABBITMQ_DEFAULT_USER: edge_user
      RABBITMQ_DEFAULT_PASS: edge_pass
    networks:
      - h2k-network

  # Subnet 2: Giả lập Edge Node khu vực B
  edge-subnet-2:
    image: rabbitmq:3-management-alpine
    container_name: rabbit-edge-2
    hostname: rabbit-edge-2
    restart: always
    ports:
      - "5673:5672"   # Map ra port khác để máy host phân biệt
      - "15673:15672" # GUI quản lý
    environment:
      RABBITMQ_DEFAULT_USER: edge_user
      RABBITMQ_DEFAULT_PASS: edge_pass
    networks:
      - h2k-network

  # =======================================================
  # VÙNG LÕI (CORE PLATFORM) - LƯU TRỮ TRUNG TÂM
  # Nơi lưu data sau khi đã xử lý/phân loại
  # =======================================================

  # 1. HOT STORAGE (Redis In-Memory)
  core-redis-hot:
    image: redis:alpine
    container_name: core-redis-hot
    restart: always
    command: redis-server --save "" --appendonly no --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    networks:
      - h2k-network

  # 2. WARM STORAGE (MongoDB)
  core-mongo-warm:
    image: mongo:7.0
    container_name: core-mongo-warm
    restart: always
    command: ["mongod", "--wiredTigerCacheSizeGB", "0.5", "--bind_ip_all"]
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password123
      MONGO_INITDB_DATABASE: warm_db
    ports:
      - "27018:27017"
    volumes:
      - ./data/warm:/data/db
    networks:
      - h2k-network
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # 3. COLD STORAGE (MongoDB)
  core-mongo-cold:
    image: mongo:7.0
    container_name: core-mongo-cold
    restart: always
    command: ["mongod", "--wiredTigerCacheSizeGB", "0.5", "--bind_ip_all"]
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password123
      MONGO_INITDB_DATABASE: cold_db
    ports:
      - "27019:27017"
    volumes:
      - ./data/cold:/data/db
    networks:
      - h2k-network
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # =======================================================
  # CÔNG CỤ QUẢN TRỊ (VISUALIZATION)
  # =======================================================
  mongo-express:
    image: mongo-express
    container_name: core-ui
    restart: always
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: password123
      ME_CONFIG_MONGODB_SERVER: core-mongo-warm,core-mongo-cold
    networks:
      - h2k-network

  # =======================================================
  # APPLICATION SERVICES (CORE BACKEND & ML)
  # =======================================================
  
  # Backend Service (Spring Boot)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: smart-city-backend
    restart: always
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker
    depends_on:
      - core-redis-hot
      - core-mongo-warm
      - core-mongo-cold
      - edge-subnet-1
      - edge-subnet-2
    networks:
      - h2k-network
    volumes:
      - ./backend/logs:/app/logs

  # ML Service (FastAPI)
  ml-service:
    build:
      context: ./ml-service
      dockerfile: Dockerfile
    container_name: smart-city-ml
    restart: always
    ports:
      - "8000:8000"
    networks:
      - h2k-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend Service (Nuxt.js) - Optional
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: smart-city-frontend
    restart: always
    ports:
      - "3000:3000"
    environment:
      NUXT_PUBLIC_API_BASE: http://smart-city-backend:8080
    depends_on:
      - backend
    networks:
      - h2k-network

networks:
  h2k-network:
    driver: bridge